openapi: 3.0.3
info:
  title: Simple Poll API
  version: 1.0.0
  description: API for user registration, authentication and polls.

servers:
  - url: http://localhost:3000
    description: Local dev

tags:
  - name: Health
  - name: Auth
  - name: Users
  - name: Polls

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  responses:
    BadRequest:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Conflict:
      description: Conflict
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    ServerError:
      description: Unexpected server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  schemas:
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
      required: [error]

    OkResponse:
      type: object
      properties:
        ok:
          type: boolean
          example: true
      required: [ok]

    Consent:
      type: object
      properties:
        tosAcceptedAt:
          type: string
          format: date-time
        tosVersion:
          type: string
        privacyAcceptedAt:
          type: string
          format: date-time
        privacyVersion:
          type: string
      required:
        - tosAcceptedAt
        - tosVersion
        - privacyAcceptedAt
        - privacyVersion

    UserPublic:
      type: object
      properties:
        id:
          type: string
          example: "256375c5-7f8c-4661-a83e-a5838b363196"
        username:
          type: string
          example: "test1"
        createdAt:
          type: string
          format: date-time
        consent:
          $ref: "#/components/schemas/Consent"
      required: [id, username, createdAt, consent]

    CreateUserRequest:
      type: object
      properties:
        username:
          type: string
          example: "test1"
        password:
          type: string
          example: "supersecret123"
        tosAccepted:
          type: boolean
          example: true
      required: [username, password, tosAccepted]

    UpdateMeRequest:
      type: object
      description: Fields are optional; include only what you want to update.
      properties:
        username:
          type: string
          example: "newname"
        password:
          type: string
          example: "newsecret123"
      additionalProperties: false

    LoginRequest:
      type: object
      properties:
        username:
          type: string
          example: "test1"
        password:
          type: string
          example: "supersecret123"
      required: [username, password]

    LoginResponse:
      type: object
      properties:
        token:
          type: string
          example: "1f2a...token..."
        user:
          $ref: "#/components/schemas/UserPublic"
      required: [token, user]

    PollOption:
      type: object
      properties:
        id:
          type: string
          example: "opt_1"
        text:
          type: string
          example: "Pizza"
        votes:
          type: integer
          example: 0
      required: [id, text, votes]

    Poll:
      type: object
      properties:
        id:
          type: string
          example: "poll_123"
        title:
          type: string
          example: "Hva skal vi spise?"
        options:
          type: array
          items:
            $ref: "#/components/schemas/PollOption"
        createdAt:
          type: string
          format: date-time
        ownerId:
          type: string
          nullable: true
        ownerUsername:
          type: string
          example: "test1"
      required: [id, title, options, createdAt, ownerId, ownerUsername]

    CreatePollRequest:
      type: object
      properties:
        title:
          type: string
          example: "Hva skal vi spise?"
        options:
          type: array
          description: Array of option strings or objects with { text } (client typically sends objects).
          items:
            oneOf:
              - type: string
                example: "Pizza"
              - type: object
                properties:
                  text:
                    type: string
                    example: "Pizza"
                required: [text]
      required: [title, options]

    ListPollsResponse:
      type: object
      properties:
        polls:
          type: array
          items:
            $ref: "#/components/schemas/Poll"
      required: [polls]

    CreatePollResponse:
      type: object
      properties:
        poll:
          $ref: "#/components/schemas/Poll"
      required: [poll]

paths:
  /health:
    get:
      tags: [Health]
      summary: Health check
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OkResponse"
        "500":
          $ref: "#/components/responses/ServerError"

  /api/v1/auth/login:
    post:
      tags: [Auth]
      summary: Login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Logged in
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/ServerError"

  /api/v1/auth/me:
    get:
      tags: [Auth]
      summary: Get current user profile
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Current user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserPublic"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/ServerError"

  /api/v1/auth/logout:
    post:
      tags: [Auth]
      summary: Logout (invalidate current session token)
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Logged out
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OkResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/ServerError"

  /api/v1/users:
    post:
      tags: [Users]
      summary: Create user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateUserRequest"
      responses:
        "201":
          description: User created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserPublic"
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/ServerError"

  /api/v1/users/me:
    patch:
      tags: [Users]
      summary: Update my user (username/password)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateMeRequest"
      responses:
        "200":
          description: Updated user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserPublic"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/ServerError"

    delete:
      tags: [Users]
      summary: Delete my user
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OkResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/ServerError"

  /api/v1/polls:
    get:
      tags: [Polls]
      summary: List polls
      responses:
        "200":
          description: Poll list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListPollsResponse"
        "500":
          $ref: "#/components/responses/ServerError"

    post:
      tags: [Polls]
      summary: Create poll
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreatePollRequest"
      responses:
        "201":
          description: Poll created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreatePollResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/ServerError"

